<!DOCTYPE html>
<HTML LANG="EN">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="style.css" rel="stylesheet" title="Default">
    <title>Outlining tool - UP847948</title>
  </head>

  <body>
    <div class="header" id="stickyHeader">
      <ul class="textButton">
        <li> <button aria-label="Bold" id="boldButton" title="Bold"><b>B</b></li>
        <li> <button aria-label="Italic" id="italicButton" title="Italic"><i>I</i></li>
        <li> <button aria-label="Underlined" id="underlineButton" title="Underline"><u>U</u></li>
        <li> <button aria-label="Outline" id="outlineButton" title="outline tool">New branch</li>
        <input type="color" aria-lavel="fontColor" id="fontColorButton" title="Font Color">
        <input type="color" aria-lavel="BGColor" id="BGColorButton" title="BG Color">
        <select id="fontChanger">
          <option value"Times New Roman">Times New Roman</option>
          <option value"Consolas">Consolas</option>
          <option value"Tahoma">Tahoma</option>
          <option value"Monospace">Monospace</option>
          <option value"Cursive">Cursive</option>
          <option value"Sans-Serif">Sans-Serif</option>
          <option value"Calibri">Calibri</option>
        </select>
        <select id="fontSizeChanger">
          <script>
            for (let i = 1; i < 11; i++){
              document.write("<option value='"+i+"'>"+i+"</option>");
            }
          </script>
        </select>
      </ul>
    </div>

    <div class="content">
      <div id="textBody" class="page" contenteditable="true">
        <!--Text editing/outlining area-->
      </div>
    </div>

    <footer id="foot">
      <h3>All HTML and CSS files used can be validated <a href="https://Validator.w3.org/check?uri=referer" target="_blank" aria-label="Validation link">here</a></h3>
    </footer>
  </body>

  <script>
    let lastKey;//global variable to check if double enter is pressed
    let test = [];
    let temp;
    setAtt();
    addListeners();
    setNew();

    function setNew(){
      let newO = document.getElementsByClassName("new");
      for (let i = 0; i < newO.length; i++){
        newO[i].addEventListener("click",function(e){
          if(this.classList.contains("new")){
            //this.focus();
          }
        });
        newO[i].addEventListener("keydown",function(e){
          if(this.classList.contains("new")){
            //insert code to replace text
            this.classList.remove("new");
          }
        });
      }
    }

    function setAtt(){
      let toggler = document.getElementsByClassName("caret");
      for (let i = 0; i < toggler.length; i++){
        if(toggler[i].getAttribute("listen") == undefined){
          toggler[i].setAttribute("listen","false");
        }
      }
    }

    function addListeners(){
      let toggler = document.getElementsByClassName("caret");
      for (let i = 0; i < toggler.length; i++){
        if(toggler[i].getAttribute("listen") == "false"){
          toggler[i].addEventListener("click", function() {
            temp = this.parentElement;
            while(temp.querySelector(".nested") == null){
              temp = temp.parentElement;
            }
            if (temp.querySelector(".nested").classList.contains("active")){
              temp.querySelector(".nested").classList.remove("active");
              this.classList.remove("caret-down");
              console.log("closed");
            }else{
              temp.querySelector(".nested").classList.add("active");
              this.classList.add("caret-down");
              console.log("opened");
            }
          });
          toggler[i].setAttribute("listen", "true");
        }
      }
    }

    function createNewOutline() { //double enter press
      let code = '<ul class="tree"><li><span class="caret"></span><span>Edit me</span><ul class="nested"><div>Edit me</div></ul></li></ul>';
      document.getElementById("textBody").insertAdjacentHTML('beforeend', code);
      setAtt();
      addListeners();
    }

    function createNewTree() { //Button press
      let code = '<ul class="tree"><li><span class="caret"></span><span class="new">Edit me</span><ul class="nested"><li><span>Edit me</span></li><li></li></ul></li></ul>';
      document.execCommand('insertHTML', false, code);
      setAtt();
      addListeners();
      setNew();
      lastKey = undefined;
    }

    function checkKey(e){
      var code = (e.keyCode ? e.keyCode : e.which);
      if (code == 13 && lastKey == 13){
        document.execCommand('outdent');
        e.preventDefault();
        lastKey = undefined;
        //createNewOutline();
      }else if (code == 8 && lastKey == 8){
        //e.preventDefault();
        //document.execCommand('outdent'); //to take element out of list
        lastKey = undefined;
      }else if (code == 9){
        e.preventDefault();
        document.execCommand("indent");
      }else{
        lastKey = code;
      }
    }

    window.onscroll = function() {
      stick()
    };

    var header = document.getElementById("stickyHeader");
    var sticky = header.offsetTop;

    function stick() {
      if (window.pageYOffset > sticky) {
        header.classList.add("sticky");
      } else {
        header.classList.remove("sticky");
      }
    }

    document.getElementById("textBody").addEventListener("keydown",checkKey);

    window.boldButton.addEventListener("click", function() {
      document.execCommand('bold', false, null);
    });
    window.italicButton.addEventListener("click", function() {
      document.execCommand('italic', false, null);
    });
    window.underlineButton.addEventListener("click", function() {
      document.execCommand('underline', false, null);
    });
    window.fontColorButton.addEventListener("change", function(e) {
      document.execCommand('ForeColor', false, e.target.value);
    });
    window.BGColorButton.addEventListener("change", function(e) {
      document.execCommand('BackColor', false, e.target.value);
    });
    window.fontChanger.addEventListener("change", function(e) {
      document.execCommand('FontName', false, e.target.value);
    });
    window.fontSizeChanger.addEventListener("change", function(e) {
      document.execCommand('FontSize', false, e.target.value);
    });

    window.outlineButton.addEventListener("click", createNewTree);
    //To do: 1. Make first input on text replace "edit me" 2. make enter on root make a new tree on newline 3. set up saving with server (node js)
    //4. bg color change of full tree breaks it? (if caret class contenteditable = false it works, but element wont delete so add a check to delete)
  </script>

</html>
